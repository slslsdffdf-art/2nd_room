<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì…êµ¬</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{ --ink:#1d130b; --rule:#b89a6a; }
  *{box-sizing:border-box}
  body{
    margin:0; padding:40px; font-family:'Noto Serif KR',serif; line-height:1.75; color:var(--ink);
    /* ë°°ê²½ì€ JSì—ì„œ ë™ì ìœ¼ë¡œ ì„¤ì •ë¨ */
    background:#1a1612;
  }
  .wrap{ max-width:520px; margin:0 auto; background:rgba(255,255,255,.88); border-radius:14px; padding:26px 22px; border:1px solid rgba(0,0,0,.08) }
  h1{ text-align:center; margin:0 0 12px; font-size:26px }
  .inp{ width:100%; padding:12px; border:1px solid var(--rule); border-radius:10px; font-size:18px }
  .btn{ display:inline-block; width:100%; padding:12px; margin-top:10px; text-align:center; border:1px solid var(--rule); border-radius:10px; background:#00000012; cursor:pointer; font-size:18px }
  .msg{ text-align:center; color:#7b5e43; min-height:24px; margin-top:8px }
</style>
</head>
<body>
  <div class="wrap">
    <h1>ì…ì¥ ë¹„ë°€ë²ˆí˜¸</h1>
    <input id="pw" class="inp" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="off" />
    <button id="go" class="btn">ì…ì¥</button>
    <div id="msg" class="msg"></div>
  </div>

<script>
/* ==== ê³µí†µ: ë¦¬ì†ŒìŠ¤ í›„ë³´ ì¤‘ ì²«ë²ˆì§¸ ì„±ê³µ ê²½ë¡œë¥¼ ê³ ë¥´ëŠ” í—¬í¼ ==== */
async function pickFirstAvailable(urls, timeoutMs=4000){
  for(const u of urls){
    try{
      const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(), timeoutMs);
      const r=await fetch(u,{method:'HEAD',cache:'no-store',signal:ctrl.signal});
      clearTimeout(t);
      if(r.ok) return u;
    }catch{}
  }
  return null;
}

/* ==== ë°°ê²½ ì´ë¯¸ì§€ ìë™ íƒì§€ & ì ìš© ==== */
(async ()=>{
  const bgCandidates = [
    '/play/css/images/parchment-bg.jpg',
    '/play/css/images/parchment-bg.webp',
    '/play/css/parchment-bg.jpg',
    '/play/css/bgm/parchment-bg.jpg',
    '/css/images/parchment-bg.jpg',
    '/images/parchment-bg.jpg'
  ];
  const bg = await pickFirstAvailable(bgCandidates);
  if(bg){
    document.body.style.background = `url('${bg}?v=4') center/cover fixed no-repeat`;
  } else {
    // ìµœì†Œí•œ ë³´ì´ëŠ” ë°°ê²½
    document.body.style.background = '#111';
  }
})();

/* ==== BGM ìë™ íƒì§€ + ì˜¤í† í”Œë ˆì´ ë¶€íŠ¸ìŠ¤íŠ¸ë© ==== */
(async ()=>{
  const bgmCandidates = [
    '/play/css/bgm/gate-theme.mp3',
    '/play/css/bgm/gate.mp3',
    '/css/bgm/gate-theme.mp3',
    '/bgm/gate-theme.mp3'
  ];
  const found = await pickFirstAvailable(bgmCandidates);
  window.BGM_SRC = found || '';  // ì—†ìœ¼ë©´ ë¬´ìŒ

  (function(){
    const state = { unlocked:false, ctx:null, el:null, trying:false };
    function makeAudioEl(src){ const a=document.createElement('audio'); a.id='bgm'; a.src=src; a.loop=true; a.preload='auto'; a.playsInline=true; a.crossOrigin='anonymous'; a.volume=0.55; document.body.appendChild(a); return a; }
    async function unlockWA(){ try{ if(state.ctx&&state.ctx.state==='running')return; state.ctx=state.ctx||new (window.AudioContext||window.webkitAudioContext)(); if(state.ctx.state!=='running')await state.ctx.resume(); const o=state.ctx.createOscillator(), g=state.ctx.createGain(); g.gain.value=0.0001; o.connect(g).connect(state.ctx.destination); o.start(); o.stop(state.ctx.currentTime+0.03);}catch{} }
    async function play(){ if(state.trying||!window.BGM_SRC) return; state.trying=true; try{ if(!state.el) state.el=makeAudioEl(window.BGM_SRC); await unlockWA(); await state.el.play(); state.unlocked=true; hide(); }catch{ show(); } finally{ state.trying=false; } }
    function arm(){ play(); ['pointerdown','keydown','touchstart'].forEach(t=>document.removeEventListener(t,arm)); }
    ['pointerdown','keydown','touchstart'].forEach(t=>document.addEventListener(t,arm,{once:true}));
    setTimeout(()=>{ if(!state.unlocked) play(); }, 1500);
    document.addEventListener('visibilitychange',()=>{ if(!state.el)return; if(document.hidden) state.el.pause(); else if(state.unlocked) state.el.play().catch(()=>{}); });
    let ov=null; function show(){ if(ov||!window.BGM_SRC) return; ov=document.createElement('div'); ov.style.cssText='position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:9999;color:#fff'; ov.innerHTML='<div style="background:#222;border:1px solid #555;padding:16px 18px;border-radius:12px;text-align:center;max-width:320px"><div style="font-size:16px;margin-bottom:8px">ğŸ”Š ë¸Œê¸ˆ í—ˆìš©</div><div style="font-size:13px;opacity:.9;margin-bottom:12px">í•œ ë²ˆ ëˆŒëŸ¬ì„œ ì†Œë¦¬ë¥¼ ì¼­ë‹ˆë‹¤</div><button id="bgmAllow" style="padding:8px 12px;border-radius:10px;border:1px solid #777;background:#333;color:#fff;cursor:pointer">ì†Œë¦¬ ì¼œê¸°</button></div>'; document.body.appendChild(ov); ov.querySelector('#bgmAllow').addEventListener('click', play); }
    function hide(){ if(!ov)return; ov.remove(); ov=null; }
    window.switchBgm=function(n){ if(!state.el) state.el=makeAudioEl(window.BGM_SRC); if(state.el.src.endsWith(n))return; state.el.pause(); state.el.src=n; state.el.currentTime=0; if(state.unlocked) state.el.play().catch(()=>{ show(); }); };
  })();
})();

/* ==== ê²Œì´íŠ¸ ë¡œê·¸ì¸ ==== */
const $=s=>document.querySelector(s), pw=$('#pw'), go=$('#go'), msg=$('#msg');
go.onclick=async ()=>{
  msg.textContent='í™•ì¸ ì¤‘â€¦';
  try{
    const cleaned=(pw.value||'').trim().normalize('NFKC');
    const r=await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({pw:cleaned})});
    const d=await r.json().catch(()=>({}));
    if(r.ok && d.ok){ location.href='/lobby.html'; } else { msg.textContent=d.error||'í‹€ë ¸ìŠµë‹ˆë‹¤.'; }
  }catch{ msg.textContent='ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜'; }
};
pw.addEventListener('keydown',e=>{ if(e.key==='Enter') go.click(); });
</script>
</body>
</html>
