<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
<title>방명록</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{ --ink:#1d130b; --rule:#b89a6a; }
  *{box-sizing:border-box}
  body{ margin:0; padding:40px; font-family:'Noto Serif KR',serif; line-height:1.75; color:var(--ink);
    background:url('/play/css/parchment-bg.jpg?v=3') center/cover fixed no-repeat; }
  .wrap{ max-width:860px; margin:0 auto; background:rgba(255,255,255,.86); border-radius:14px; padding:24px 20px; border:1px solid rgba(0,0,0,.08) }
  h1{ margin:0 0 12px; text-align:center; font-size:26px }
  .item{ border-bottom:1px solid #d8c6a3; padding:12px 6px }
  .meta{ font-size:14px; color:#6d553e }
  .text{ white-space:pre-wrap; margin-top:6px }
  .ctrls{ display:flex; justify-content:space-between; align-items:center; margin-top:8px }
  .btn{ padding:6px 10px; border:1px solid var(--rule); border-radius:8px; background:#0000000e; cursor:pointer }
  .pager{ text-align:center; margin-top:14px }
</style>
</head>
<body>
  <div class="wrap">
    <h1>유언 방명록</h1>
    <div id="list"></div>
    <div class="pager">
      <button id="prev" class="btn">이전</button>
      <span id="pageInfo"></span>
      <button id="next" class="btn">다음</button>
    </div>
  </div>

<script>
window.BGM_SRC = '/play/css/wall-theme.mp3';
/* 공통 BGM 부트스트랩 */
(function(){const s={unlocked:false,ctx:null,el:null,trying:false};function m(src){const a=document.createElement('audio');a.id='bgm';a.src=src;a.loop=true;a.preload='auto';a.playsInline=true;a.crossOrigin='anonymous';a.volume=0.5;document.body.appendChild(a);return a;}async function u(){try{if(s.ctx&&s.ctx.state==='running')return;s.ctx=s.ctx||new (window.AudioContext||window.webkitAudioContext)();if(s.ctx.state!=='running')await s.ctx.resume();const o=s.ctx.createOscillator(),g=s.ctx.createGain();g.gain.value=0.0001;o.connect(g).connect(s.ctx.destination);o.start();o.stop(s.ctx.currentTime+0.03);}catch{}}async function p(){if(s.trying)return;s.trying=true;try{if(!s.el)s.el=m(window.BGM_SRC);await u();await s.el.play();s.unlocked=true;h();}catch(e){q();}finally{s.trying=false;}}function O(){p();['pointerdown','keydown','touchstart'].forEach(t=>document.removeEventListener(t,O));}['pointerdown','keydown','touchstart'].forEach(t=>document.addEventListener(t,O,{once:true}));setTimeout(()=>{if(!s.unlocked)p();},1500);document.addEventListener('visibilitychange',()=>{if(!s.el)return; if(document.hidden)s.el.pause(); else if(s.unlocked)s.el.play().catch(()=>{});});let v=null;function q(){if(v)return;v=document.createElement('div');v.style.cssText='position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:9999;color:#fff';v.innerHTML='<div style="background:#222;border:1px solid #555;padding:16px 18px;border-radius:12px;text-align:center;max-width:320px"><div style="font-size:16px;margin-bottom:8px">🔊 브금 허용</div><div style="font-size:13px;opacity:.9;margin-bottom:12px">한 번 눌러서 소리를 켭니다</div><button id="bgmAllow" style="padding:8px 12px;border-radius:10px;border:1px solid #777;background:#333;color:#fff;cursor:pointer">소리 켜기</button></div>';document.body.appendChild(v);v.querySelector('#bgmAllow').addEventListener('click',p);}function h(){if(!v)return;v.remove();v=null;}window.switchBgm=function(n){if(!s.el)s.el=m(window.BGM_SRC);if(s.el.src.endsWith(n))return;s.el.pause();s.el.src=n;s.el.currentTime=0;if(s.unlocked)s.el.play().catch(()=>{q();});};})();

/* 방명록 로딩 */
const $=(s)=>document.querySelector(s);
const listEl=$('#list'), prevBtn=$('#prev'), nextBtn=$('#next'), pageInfo=$('#pageInfo');
let page=1, limit=20, isAdmin=false, total=0;
function timefmt(ts){ try{ const d=new Date(ts); return d.toLocaleString(); }catch(_){ return '';} }
async function load(){
  const r=await fetch(`/api/lines?page=${page}&limit=${limit}`, {cache:'no-store'});
  const d=await r.json();
  isAdmin = !!d.admin; total = d.total||0; pageInfo.textContent = `페이지 ${page}`;
  listEl.innerHTML = '';
  (d.items||[]).forEach((it)=>{
    const n = it.number ?? it.id;
    const div=document.createElement('div'); div.className='item';
    const esc = s => s.replace(/[&<>]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[m]));
    div.innerHTML = `
      <div class="meta">탈출자 ${n} · 원인: <b>${it.cause||'—'}</b> · 단계 ${it.step??0} · ${timefmt(it.ts)}</div>
      <div class="text">${esc(it.text||'')}</div>
      <div class="ctrls">
        <span class="meta">src: ${it.src||'user'}</span>
        ${isAdmin? `<button data-id="${it.id}" class="btn del">삭제</button>` : ``}
      </div>`;
    listEl.appendChild(div);
  });
  if(isAdmin){
    listEl.querySelectorAll('.del').forEach(b=>{
      b.onclick=async ()=>{
        const id = +b.getAttribute('data-id');
        if(!confirm(`정말 삭제할까요? #${id}`)) return;
        const r=await fetch(`/api/lines?id=${id}`,{method:'DELETE'});
        if(r.ok){ alert('삭제됨(번호 재정렬)'); load(); }
      };
    });
  }
}
prevBtn.onclick=()=>{ if(page>1){ page--; load(); } };
nextBtn.onclick=()=>{ page++; load(); };
load();
</script>
</body>
</html>
