<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>끝없는 복도</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{--ink:#2b1b0e;--rule:#b89a6a;--bg:rgba(255,255,255,.78)}
  *{box-sizing:border-box}
  body{margin:0;background:url('/images/parchment-bg.jpg') center/cover fixed no-repeat;
       font-family:'Noto Serif KR',serif;color:var(--ink)}
  .wrap{max-width:920px;margin:0 auto;min-height:100vh;padding:32px}
  .card{background:var(--bg);border:1px solid var(--rule);border-radius:14px;padding:22px 20px;
        box-shadow:0 8px 30px rgba(0,0,0,.08)}
  h1{margin:0 0 18px;font-size:28px;text-align:center}
  .row{display:flex;gap:14px;justify-content:center;margin:18px 0 8px}
  .btn{min-width:160px;padding:14px 16px;border:1px solid var(--rule);border-radius:10px;
       background:#f2e4c9;cursor:pointer;font-weight:600}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .hint{text-align:center;font-size:14px;opacity:.8}
  .meta{margin-top:10px;text-align:center;opacity:.8}
  /* modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.58);display:none;align-items:center;justify-content:center}
  .modal.show{display:flex}
  .sheet{width:min(680px,92vw);background:#fff; border-radius:14px; padding:18px;border:1px solid var(--rule)}
  .sheet h2{margin:0 0 8px}
  textarea{width:100%;height:120px;padding:10px;border:1px solid var(--rule);border-radius:10px;resize:vertical}
  .right{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
  .toast{position:fixed;left:50%;bottom:26px;transform:translateX(-50%);background:#000;color:#fff;
         padding:10px 14px;border-radius:8px;opacity:0;transition:opacity .2s}
  .toast.show{opacity:1}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>끝없는 복도</h1>
    <div class="hint">운명의 갈림길. <b>왼쪽·정면·오른쪽</b> 중 하나를 선택하세요.</div>
    <div class="row">
      <button class="btn" id="btnL">왼쪽</button>
      <button class="btn" id="btnF">정면</button>
      <button class="btn" id="btnR">오른쪽</button>
    </div>
    <div class="meta" id="status">시도 준비됨…</div>
  </div>
</div>

<!-- Death modal -->
<div class="modal" id="deathModal" aria-hidden="true">
  <div class="sheet">
    <h2>사망했습니다.</h2>
    <p style="margin:6px 0 10px">마지막으로 남길 말을 적을 수 있습니다. (선택)</p>
    <textarea id="lwText" placeholder="다음 도전자에게 전할 말(최대 160자)"></textarea>
    <div class="right">
      <button class="btn" id="skipLW">건너뛰기</button>
      <button class="btn" id="sendLW">유언 남기기</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const $ = (s)=>document.querySelector(s);
const statusEl = $('#status');
const btns = [$('#btnL'), $('#btnF'), $('#btnR')];
const deathModal = $('#deathModal');
const lwText = $('#lwText');
const toast = $('#toast');

function showToast(msg){ toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1500); }
function lockButtons(on){ btns.forEach(b=>b.disabled=on); }

async function callChoose(dir){
  lockButtons(true);
  statusEl.textContent = '결과 판정 중…';
  try{
    const r = await fetch('/api/choose',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({dir})});
    if(r.status===401){ location.href='/'; return; }
    const data = await r.json();
    if(!r.ok){ showToast(data.error||'오류'); lockButtons(false); return; }

    if(data.result==='advance'){
      statusEl.textContent = `생존! 다음 방으로 전진했습니다. (누적 단계 ${data.step})`;
      lockButtons(false);
    }else if(data.result==='dead'){
      statusEl.textContent = `사망… (${data.cause})`;
      // 모달 오픈
      deathModal.classList.add('show');
      deathModal.setAttribute('aria-hidden','false');
      lwText.focus();
    }else{
      showToast('알 수 없는 응답');
      lockButtons(false);
    }
  }catch(e){
    showToast('네트워크 오류');
    lockButtons(false);
  }
}

btns[0].addEventListener('click', ()=>callChoose('L'));
btns[1].addEventListener('click', ()=>callChoose('F'));
btns[2].addEventListener('click', ()=>callChoose('R'));

// 유언 전송
$('#sendLW').addEventListener('click', async ()=>{
  const text = (lwText.value||'').trim();
  try{
    const r = await fetch('/api/lastwords',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
    if(r.status===401){ location.href='/'; return; }
    const data = await r.json();
    if(!r.ok){ showToast(data.error||'전송 실패'); return; }
    location.href = '/log/'; // 방명록으로
  }catch(e){ showToast('네트워크 오류'); }
});

// 스킵 → 방명록
$('#skipLW').addEventListener('click', ()=>{ location.href='/log/'; });

// 최초 진입 초기화
(async()=>{
  try{
    const r = await fetch('/api/choose?init=1');
    if(r.status===401){ location.href='/'; return; }
  }catch{}
})();
</script>
</body>
</html>
