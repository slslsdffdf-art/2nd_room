<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>두 번째 방 – 진행</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600&display=swap" rel="stylesheet">
<style>
  body{margin:0;padding:28px;font-family:'Noto Serif KR',serif;background:url('/images/parchment-bg.jpg') center/cover fixed no-repeat;color:#2b1b0e}
  .wrap{max-width:760px;margin:0 auto;background:rgba(255,255,255,.78);border-radius:14px;padding:20px 18px}
  .row{display:flex;gap:10px;justify-content:center;margin:16px 0}
  button.choice{flex:1;max-width:200px;padding:14px 10px;border:0;border-radius:12px;background:#caa56a;cursor:pointer;font-weight:700}
  .status{min-height:28px;text-align:center;margin-top:8px}
  .dead{color:#7b1f1f}
  .timer{font-weight:700}
  textarea{width:100%;height:120px;resize:vertical}
  .hidden{display:none}
  a.btn{display:inline-block;margin-top:10px;padding:10px 14px;background:#2b1b0e;color:#fff;border-radius:10px;text-decoration:none}
</style>
</head>
<body>
<div class="wrap">
  <h2 style="margin-top:4px">끝없는 복도</h2>
  <p>왼쪽 / 정면 / 오른쪽 중 하나를 선택하세요. (<span class="timer" id="timer">90</span>초)</p>
  <div class="row">
    <button class="choice" data-dir="L">왼쪽</button>
    <button class="choice" data-dir="F">정면</button>
    <button class="choice" data-dir="R">오른쪽</button>
  </div>
  <div class="status" id="status"></div>

  <div id="death" class="hidden">
    <h3 class="dead">사망했습니다.</h3>
    <p>유언을 남길 수 있습니다. (최대 300자)</p>
    <textarea id="lw" placeholder="다음 도전자에게 전할 말(선택)"></textarea>
    <div class="row" style="justify-content:flex-end">
      <button id="saveLW" class="choice" style="max-width:160px">유언 남기기</button>
    </div>
    <p><a class="btn" href="/play/wall.html">방명록 보기</a></p>
  </div>
</div>

<script>
const statusEl = document.getElementById('status');
const timerEl  = document.getElementById('timer');
const deathBox = document.getElementById('death');
const lwEl = document.getElementById('lw');
const saveLW = document.getElementById('saveLW');

let left = 90, ticking=true;
const tick = ()=>{
  if(!ticking) return;
  timerEl.textContent = left;
  if(left<=0){
    ticking=false;
    // 시간초과 == 사망 처리처럼 안내
    statusEl.innerHTML = '<span class="dead">시간 초과로 죽음에 이르렀습니다.</span>';
    deathBox.classList.remove('hidden');
    return;
  }
  left--; setTimeout(tick, 1000);
};

async function init(){
  const r = await fetch('/api/choose?init=1', { credentials:'same-origin' });
  if(!r.ok){ location.href='/'; return; }
  tick();
}
init();

document.querySelectorAll('.choice').forEach(btn=>{
  if(btn.id==='saveLW') return;
  btn.addEventListener('click', async ()=>{
    if(!ticking) return;
    ticking=false;
    const dir = btn.dataset.dir;
    statusEl.textContent = '이동 중...';
    const r = await fetch('/api/choose', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      credentials:'same-origin',
      body: JSON.stringify({ dir })
    });
    const data = await r.json().catch(()=>({}));
    if(data.result==='advance'){
      statusEl.textContent = `전진합니다. 현재 단계: ${data.step}`;
      // 다음 선택을 위해 타이머 리셋
      left = 90; ticking=true; tick();
    }else if(data.result==='dead'){
      statusEl.innerHTML = `<span class="dead">사망: ${data.cause}</span>`;
      deathBox.classList.remove('hidden');
    }else{
      statusEl.textContent = '오류가 발생했습니다.';
    }
  });
});

saveLW.addEventListener('click', async ()=>{
  const text = lwEl.value.trim();
  const r = await fetch('/api/lastwords', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'same-origin',
    body: JSON.stringify({ text })
  });
  if(r.ok){
    saveLW.disabled = true;
    saveLW.textContent = '저장됨';
    location.href = '/play/wall.html';
  }else{
    alert('저장 실패');
  }
});
</script>
</body>
</html>
