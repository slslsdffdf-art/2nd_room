<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>두 번째 방 – 플레이</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{margin:0;min-height:100dvh;display:grid;place-items:center;
      background:url("/images/parchment-bg.jpg") center/cover no-repeat fixed;
      font-family:"Noto Serif KR",serif}
    .card{background:rgba(255,255,255,.82);padding:24px 20px;border-radius:12px;max-width:760px;width:92vw}
    h1{margin:0 0 10px}
    .row{display:flex;gap:10px;margin-top:12px}
    button{flex:1;padding:14px;font-size:18px;cursor:pointer}
    #desc{white-space:pre-line}
  </style>
</head>
<body>
  <div class="card">
    <h1>끝없는 복도</h1>
    <p id="desc">세션을 준비하는 중…</p>
    <div class="row">
      <button data-dir="L">왼쪽</button>
      <button data-dir="F">정면</button>
      <button data-dir="R">오른쪽</button>
    </div>
  </div>

  <script>
    const desc = document.getElementById('desc');

    async function init() {
      const r = await fetch('/api/choose?init=1');
      if (r.status === 401) return location.href='/?err=session';
      const j = await r.json().catch(()=>({step:0}));
      desc.textContent = `현재 단계: ${j.step}\n방향을 고르세요.`;
    }

    async function pick(dir){
      const r = await fetch('/api/choose', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ dir })
      });
      if (r.status === 401) return location.href='/?err=session';
      const j = await r.json().catch(()=>({}));

      if (j.result === 'advance') {
        desc.textContent = `성공! 현재 단계: ${j.step}\n계속 진행하세요.`;
      } else if (j.result === 'dead') {
        desc.textContent = '사망했습니다. 유언을 남길 수 있습니다.';
        document.querySelectorAll('button').forEach(b=>b.disabled=true);
        const msg = prompt('마지막 한마디(선택):');
        if (msg && msg.trim()){
          await fetch('/api/lastwords', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ text: msg.trim() })
          }).catch(()=>{});
        }
        alert('고생하셨습니다.');
        location.href='/play/'; // 임시로 같은 페이지 유지
      } else {
        alert(j.error || '오류');
      }
    }

    document.querySelectorAll('button').forEach(b=>{
      b.addEventListener('click', ()=>pick(b.dataset.dir));
    });

    init();
  </script>
</body>
</html>
