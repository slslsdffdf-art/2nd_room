<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>끝없는 복도 — 플레이</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600;700&family=Cinzel:wght@700&display=swap" rel="stylesheet">
<style>
  :root{ --ink:#2b1b0e; --veil:rgba(255,255,255,.78); --rule:#b89a6a }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh; display:grid; place-items:center;
    font-family:'Noto Serif KR',serif; color:var(--ink);
    background:url('/images/parchment-bg.jpg') center/cover fixed no-repeat;
  }
  .wrap{ width:min(780px,92vw); background:var(--veil); border-radius:14px; padding:22px 18px }
  h1{ font-family:'Cinzel',serif; margin:0 0 6px; text-align:center }
  .row{ display:flex; gap:10px; justify-content:center; margin:14px 0 }
  button.choice{ padding:14px 18px; font-size:18px; border:1px solid var(--rule); background:#fffdf6; border-radius:10px; cursor:pointer }
  .meta{ display:flex; justify-content:space-between; gap:10px; font-size:14px; color:#6a5436; border-top:1px solid var(--rule); padding-top:10px; margin-top:10px }
  .hint{ font-size:14px; color:#6a5436; margin-top:8px; }
  .dead{ position:fixed; inset:0; background:rgba(0,0,0,.78); display:none; align-items:center; justify-content:center; }
  .modal{ width:min(640px,92vw); background:#121212; color:#eee; border:1px solid #333; border-radius:12px; padding:16px }
  textarea{ width:100%; min-height:110px; resize:vertical; padding:10px; font-size:15px }
  .err{ color:#e88; min-height:18px }
</style>
</head>
<body>
<div class="wrap">
  <h1>끝없는 복도</h1>
  <p id="desc">복도는 세 갈래로 갈라진다. 택하라.</p>

  <div class="row">
    <button class="choice" data-c="L">왼쪽</button>
    <button class="choice" data-c="F">정면</button>
    <button class="choice" data-c="R">오른쪽</button>
  </div>

  <div class="meta">
    <div>남은 시간: <b id="timer">120</b>초</div>
    <div id="lastHint">직전 유언: (비공개)</div>
  </div>
  <div class="hint">* 사망 시 유언 1문장을 남길 수 있습니다. (최대 140자)</div>
</div>

<!-- 사망 모달 -->
<div class="dead" id="dead">
  <div class="modal">
    <h3 style="margin:0 0 6px">너는 실패했다.</h3>
    <p style="margin:0 0 10px">단 한 줄을 남겨라. (30초)</p>
    <textarea id="lw" placeholder="유언을 입력하세요 (선택, 140자)"></textarea>
    <div class="err" id="derr"></div>
    <div style="display:flex; gap:8px; justify-content:flex-end">
      <button id="submitLW">유언 제출</button>
      <button id="skipLW">말 없이 떠난다</button>
    </div>
  </div>
</div>

<script>
let t = 120, tick;
const timerEl = document.getElementById('timer');
const deadEl = document.getElementById('dead');
const derrEl = document.getElementById('derr');
const lastHintEl = document.getElementById('lastHint');

async function fetchLastHint(){
  try{
    const r = await fetch('/api/lines?mode=one'); // 직전 1개
    if(!r.ok) return;
    const j = await r.json();
    if(j && j.item){
      lastHintEl.textContent = '직전 유언: ' + (j.item.textMasked || '(없음)');
    }
  }catch{}
}
fetchLastHint();

function startTimer(){
  clearInterval(tick);
  t = 120; timerEl.textContent = t;
  tick = setInterval(()=> {
    t--; timerEl.textContent = t;
    if (t<=0){ clearInterval(tick); autoFail(); }
  }, 1000);
}
startTimer();

document.querySelectorAll('.choice').forEach(btn=>{
  btn.addEventListener('click', ()=> choose(btn.dataset.c));
});

async function choose(c){
  // 선택 전 잠금(중복 클릭 방지)
  document.querySelectorAll('.choice').forEach(b=> b.disabled = true);
  try{
    const r = await fetch('/api/choose', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ choice: c })
    });
    const j = await r.json().catch(()=> ({}));
    if(!r.ok) throw new Error(j.error || '오류');

    if(j.ok){ // 전진
      startTimer();
      document.querySelectorAll('.choice').forEach(b=> b.disabled = false);
    }else{
      // 사망
      showDeath(j);
    }
  }catch(e){
    alert(e.message || '오류');
    document.querySelectorAll('.choice').forEach(b=> b.disabled = false);
  }
}

function showDeath(j){
  clearInterval(tick);
  deadEl.style.display = 'flex';
  // 공유 카드용 데이터 전역 예시
  window.DEATH_RESULT = {
    num: j.num, step: j.step, cause: j.cause || '선택 실패', lastWords: ''
  };
}

async function autoFail(){
  // 시간초과 → 자동 실패 처리
  const r = await fetch('/api/choose', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ choice: 'TIMEOUT' })
  });
  const j = await r.json().catch(()=> ({}));
  showDeath(j);
}

// 유언 제출/스킵
document.getElementById('submitLW').addEventListener('click', submitLW);
document.getElementById('skipLW').addEventListener('click', ()=> submitLW(true));

async function submitLW(skip=false){
  derrEl.textContent='';
  const text = skip ? '' : (document.getElementById('lw').value || '').trim();
  const r = await fetch('/api/lastwords', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ text })
  });
  if(r.ok){
    location.href = '/'; // 사망자는 방명록(전체 열람) 페이지로 보내도 됨(추후)
  }else{
    const j = await r.json().catch(()=> ({}));
    derrEl.textContent = j.error || '유언 저장 실패';
  }
}
</script>
</body>
</html>