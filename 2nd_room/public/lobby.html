<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
<title>대기열</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{ --ink:#1d130b; --rule:#b89a6a; }
  *{box-sizing:border-box}
  body{ margin:0; padding:40px; font-family:'Noto Serif KR',serif; color:var(--ink); line-height:1.75; background:#1a1612; }
  .wrap{ max-width:720px; margin:0 auto; background:rgba(255,255,255,.84); border-radius:14px; padding:28px 22px; border:1px solid rgba(0,0,0,.08) }
  h1{ margin:0 0 10px; text-align:center; font-size:28px }
  .box{ background:linear-gradient(180deg,#fff8ea,#f7efe2); border:1px solid var(--rule); border-radius:10px; padding:14px 16px; }
  .center{text-align:center}.muted{color:#6d553e}
  .btn{ display:inline-block; padding:10px 14px; border:1px solid var(--rule); border-radius:10px; background:#0000000e; cursor:pointer }
</style>
</head>
<body>
  <div class="wrap">
    <h1>대기열</h1>
    <div class="box">
      <p class="center">현재 대기 인원: <b id="size">–</b></p>
      <p class="center">내 순번: <b id="pos">–</b></p>
      <p class="center">예상 대기: <b id="eta">–</b></p>
      <p class="center muted" style="margin-top:8px">입장 가능 시 자동으로 게임으로 이동합니다.</p>
      <p class="center" style="margin-top:10px"><button id="leaveBtn" class="btn">대기 취소</button></p>
    </div>
  </div>

<script>
async function pickFirstAvailable(urls, timeoutMs=4000){
  for(const u of urls){
    try{ const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(),timeoutMs);
      const r=await fetch(u,{method:'HEAD',cache:'no-store',signal:ctrl.signal}); clearTimeout(t);
      if(r.ok) return u;
    }catch{}
  } return null;
}
(async ()=>{
  const bg = await pickFirstAvailable([
    '/play/css/images/parchment-bg.jpg','/play/css/images/parchment-bg.webp',
    '/css/images/parchment-bg.jpg','/images/parchment-bg.jpg'
  ]);
  document.body.style.background = bg ? `url('${bg}?v=4') center/cover fixed no-repeat` : '#111';
})();
(async ()=>{
  const src = await pickFirstAvailable([
    '/play/css/bgm/lobby-theme.mp3','/css/bgm/lobby-theme.mp3','/bgm/lobby-theme.mp3'
  ]);
  window.BGM_SRC = src || '';
  (function(){
    const s={unlocked:false,ctx:null,el:null,trying:false};
    function m(u){const a=document.createElement('audio');a.id='bgm';a.src=u;a.loop=true;a.preload='auto';a.playsInline=true;a.crossOrigin='anonymous';a.volume=0.55;document.body.appendChild(a);return a;}
    async function u(){try{if(s.ctx&&s.ctx.state==='running')return;s.ctx=s.ctx||new (window.AudioContext||window.webkitAudioContext)();if(s.ctx.state!=='running')await s.ctx.resume();const o=s.ctx.createOscillator(),g=s.ctx.createGain();g.gain.value=0.0001;o.connect(g).connect(s.ctx.destination);o.start();o.stop(s.ctx.currentTime+0.03);}catch{}}
    async function p(){if(s.trying||!window.BGM_SRC)return;s.trying=true;try{if(!s.el)s.el=m(window.BGM_SRC);await u();await s.el.play();s.unlocked=true;h();}catch{q();}finally{s.trying=false;}}
    function arm(){p();['pointerdown','keydown','touchstart'].forEach(t=>document.removeEventListener(t,arm));}
    ['pointerdown','keydown','touchstart'].forEach(t=>document.addEventListener(t,arm,{once:true}));
    setTimeout(()=>{if(!s.unlocked)p();},1500);
    document.addEventListener('visibilitychange',()=>{if(!s.el)return; if(document.hidden)s.el.pause(); else if(s.unlocked)s.el.play().catch(()=>{});});
    let v=null; function q(){ if(v||!window.BGM_SRC)return; v=document.createElement('div'); v.style.cssText='position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:9999;color:#fff'; v.innerHTML='<div style="background:#222;border:1px solid #555;padding:16px 18px;border-radius:12px;text-align:center;max-width:320px"><div style="font-size:16px;margin-bottom:8px">🔊 브금 허용</div><div style="font-size:13px;opacity:.9;margin-bottom:12px">한 번 눌러서 소리를 켭니다</div><button id="bgmAllow" style="padding:8px 12px;border:1px solid #777;background:#333;color:#fff;border-radius:10px;cursor:pointer">소리 켜기</button></div>'; document.body.appendChild(v); v.querySelector('#bgmAllow').addEventListener('click',p); }
    function h(){ if(!v)return; v.remove(); v=null; }
    window.switchBgm=function(n){ if(!s.el)s.el=m(window.BGM_SRC); if(s.el.src.endsWith(n))return; s.el.pause(); s.el.src=n; s.el.currentTime=0; if(s.unlocked)s.el.play().catch(()=>{q();}); };
  })();
})();

/* 대기열 폴링 */
const $=(s)=>document.querySelector(s);
const sizeEl=$('#size'), posEl=$('#pos'), etaEl=$('#eta'), leaveBtn=$('#leaveBtn');
function fmtETA(sec){ sec=Math.max(0,sec|0); const m=Math.floor(sec/60), s=sec%60; return m? `${m}분 ${s}초` : `${s}초`; }
async function poll(){
  try{
    const r=await fetch('/api/queue',{cache:'no-store'});
    if(r.status===401){ location.href='/'; return; }
    const d=await r.json();
    if(d.state==='active' || d.state==='dead_pending'){ location.replace('/play/index.html'); return; }
    if(d.state==='finished'){ location.replace('/play/wall.html'); return; }
    if(d.state==='waiting'){
      sizeEl.textContent = d.size ?? '–';
      posEl.textContent = d.position ?? '–';
      etaEl.textContent = d.est_sec!=null ? fmtETA(d.est_sec) : '–';
    } else { location.replace('/play/index.html'); }
  }catch{}
}
setInterval(poll, 3000); poll();
leaveBtn.onclick=async ()=>{ try{ const r=await fetch('/api/queue',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({leave:true})}); if(r.ok) location.href='/'; }catch{ location.href='/'; } };
</script>
</body>
</html>
