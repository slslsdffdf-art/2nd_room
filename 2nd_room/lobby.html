<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
<title>로비 – 대기열</title>
<style>
  body{margin:0;padding:40px;background:url('/images/parchment-bg.jpg') center/cover fixed no-repeat;color:#2b1b0e;font-family:'Noto Serif KR',serif}
  .card{max-width:560px;margin:10vh auto;background:rgba(255,255,255,.76);border-radius:12px;padding:24px 20px}
  h1{text-align:center;margin:0 0 10px}
  .num{font-size:28px;text-align:center;margin:8px 0}
  .small{color:#795548;text-align:center}
  .btn{display:block;margin:16px auto 0;padding:10px 14px;border:1px solid #b89a6a;border-radius:8px;background:#f7efe2;cursor:pointer}
</style>
<script>
  if (document.cookie.includes('auth2=wall')) location.replace('/play/wall');
  if (document.cookie.includes('auth2=ok')) location.replace('/play/');
</script>
</head>
<body>
  <div class="card">
    <h1>대기열</h1>
    <div class="num">내 위치: <span id="pos">-</span></div>
    <p class="small">예상 대기시간: <span id="eta">계산 중…</span></p>
    <button class="btn" id="leaveBtn">대기 취소</button>
  </div>
<script>
const pos=document.getElementById('pos'), eta=document.getElementById('eta');
const leaveBtn=document.getElementById('leaveBtn');
function fmt(sec){ sec=parseInt(sec||0,10); const m=Math.floor(sec/60), s=sec%60; return `${m}분 ${s.toString().padStart(2,'0')}초`; }

async function tick(){
  try{
    const r=await fetch('/api/queue'); const d=await r.json();
    if(d.state==='active' || d.state==='ready'){ location.replace('/play/'); return; }
    if(d.state==='waiting'){
      pos.textContent = d.position || 1;
      eta.textContent = fmt(d.est_sec);
    }else{
      eta.textContent = '대기 정보 없음';
    }
  }catch{}
}
setInterval(tick, 2000); tick();

leaveBtn.onclick = async ()=>{
  if(!confirm('대기열에서 나가시겠습니까?')) return;
  await fetch('/api/queue',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({leave:true})});
  location.href='/';
};
</script>
</body>
</html>